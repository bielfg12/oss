<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Participantes</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    #map { height: 500px; }
  </style>
</head>
<body>
  <h1>Relatório de Participantes</h1>
  
  <form id="participantForm">
    <input type="text" id="name" placeholder="Nome" required>
    <input type="text" id="phone" placeholder="Telefone" required>
    <input type="text" id="city" placeholder="Cidade" required>
    <select id="status">
      <option value="participou">Participou</option>
      <option value="nao_participou">Não Participou</option>
      <option value="participou_outros">Participou com Outros</option>
    </select>
    <button type="submit">Adicionar</button>
  </form>

  <div id="map"></div>

  <!-- Importa o arquivo de configuração do Firebase (já configurado na sua pasta js/firebase-config.js) -->
  <script type="module" src="./js/firebase-config.js"></script>
  <!-- Firebase e Firestore -->
  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    // Defina as coordenadas para as cidades (adicione conforme necessário)
    const cityCoordinates = {
      "São Paulo": [-23.5505, -46.6333],
      "Bauru": [-22.3147, -49.0606],
      "Piracicaba": [-22.7338, -47.6476],
      "Campinas": [-22.9056, -47.0608],
      "Santos": [-23.9608, -46.3339]
      // Adicione outras cidades conforme necessário
    };

    // Inicializa o mapa do Leaflet centrado em São Paulo (ou região desejada)
    const map = L.map('map').setView([-23.5505, -46.6333], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Cria o grupo de clusters para os marcadores
    const markersCluster = L.markerClusterGroup({
      spiderfyOnMaxZoom: true,  // Se os marcadores estiverem exatamente no mesmo ponto, eles se dispersam
      showCoverageOnHover: false,
      zoomToBoundsOnClick: false  // Vamos customizar o clique para exibir uma lista
    });
    map.addLayer(markersCluster);

    // Quando um cluster for clicado, exibe um popup com a lista dos participantes daquele grupo
    markersCluster.on('clusterclick', function (a) {
      const markers = a.layer.getAllChildMarkers();
      let content = '<ul>';
      markers.forEach(marker => {
        const p = marker.options.participant;
        content += `<li>${p.name} - ${p.phone}</li>`;
      });
      content += '</ul>';
      L.popup()
        .setLatLng(a.latlng)
        .setContent(content)
        .openOn(map);
    });

    // Ao enviar o formulário, adiciona o participante no Firestore
    document.getElementById("participantForm").addEventListener("submit", async function (event) {
      event.preventDefault();
      const name = document.getElementById("name").value;
      const phone = document.getElementById("phone").value;
      const city = document.getElementById("city").value;
      const status = document.getElementById("status").value;

      if (!cityCoordinates[city]) {
        alert("Cidade não cadastrada no sistema.");
        return;
      }

      try {
        await addDoc(collection(db, "participants"), { name, phone, city, status });
        alert("Participante adicionado!");
        loadParticipants();  // Atualiza a lista e os marcadores
      } catch (error) {
        console.error("Erro ao adicionar participante:", error);
      }
    });

    // Carrega os participantes do Firestore, atualiza a lista e adiciona os marcadores ao cluster
    async function loadParticipants() {
      // Atualiza a lista de participantes (HTML)
      const list = document.getElementById("participantsList");
      list.innerHTML = '';

      // Limpa os marcadores do cluster
      markersCluster.clearLayers();

      const querySnapshot = await getDocs(collection(db, "participants"));
      querySnapshot.forEach((doc) => {
        const participant = doc.data();

        // Atualiza a lista (ul) com os dados do participante
        const li = document.createElement("li");
        li.textContent = `${participant.name} - ${participant.phone} - ${participant.city} - ${participant.status}`;
        list.appendChild(li);

        // Se existir coordenada para a cidade, cria o marcador
        if (cityCoordinates[participant.city]) {
          // Define a cor do marcador conforme o status
          let color;
          if (participant.status === "participou") {
            color = "green";
          } else if (participant.status === "nao_participou") {
            color = "red";
          } else { // "participou_outros"
            color = "yellow";
          }

          // Cria um marcador (usando circleMarker para facilitar a customização da cor)
          const marker = L.circleMarker(cityCoordinates[participant.city], {
            color: color,
            radius: 8,
            fillOpacity: 0.8
          });
          // Armazena as informações do participante nas opções do marcador
          marker.options.participant = participant;

          // Para cada marcador individual, vincula um popup com nome e telefone
          marker.bindPopup(`<strong>${participant.name}</strong><br>Telefone: ${participant.phone}`);

          // Adiciona o marcador ao grupo de clusters
          markersCluster.addLayer(marker);
        }
      });
    }

    // Carrega os participantes e os marcadores ao iniciar a página
    document.addEventListener("DOMContentLoaded", loadParticipants);
  </script>

  <!-- Inclua os scripts do Leaflet e do MarkerCluster (eles podem ser carregados após o seu script de lógica) -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
</body>
</html>
