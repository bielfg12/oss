<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro de Participantes</title>
  <!-- Fontes e CSS Moderno -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-top: 20px;
      color: #333;
    }
    form {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      width: 90%;
      max-width: 500px;
    }
    form input, form select, form button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px;
    }
    form button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    form button:hover {
      background: #0056b3;
    }
    #map {
      width: 90%;
      max-width: 1000px;
      height: 500px;
      border: 2px solid #ccc;
      border-radius: 8px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Cadastro de Participantes</h1>
  
  <form id="participantForm">
    <input type="text" id="name" placeholder="Nome" required />
    <input type="text" id="phone" placeholder="Telefone" required />
    <!-- Campo de seleção de cidade para evitar erros de digitação -->
    <select id="city" required>
      <option value="">Selecione a cidade</option>
      <option value="São Paulo">São Paulo</option>
      <option value="Bauru">Bauru</option>
      <option value="Piracicaba">Piracicaba</option>
      <option value="Campinas">Campinas</option>
      <option value="Santos">Santos</option>
    </select>
    <select id="status" required>
      <option value="participou">Participou</option>
      <option value="nao_participou">Não Participou</option>
      <option value="participou_outros">Participou com Outros</option>
    </select>
    <button type="submit">Adicionar Participante</button>
  </form>

  <!-- Mapa -->
  <div id="map"></div>

  <!-- Importa a configuração do Firebase -->
  <script type="module" src="./js/firebase-config.js"></script>
  <!-- Inclua o Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Código de lógica -->
  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    // Defina as coordenadas para as cidades (use as mesmas chaves do select)
    const cityCoordinates = {
      "São Paulo": [-23.5505, -46.6333],
      "Bauru": [-22.3147, -49.0606],
      "Piracicaba": [-22.7338, -47.6476],
      "Campinas": [-22.9056, -47.0608],
      "Santos": [-23.9608, -46.3339]
    };

    // Inicializa o mapa com Leaflet
    const map = L.map('map').setView([-23.5505, -46.6333], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Cria o grupo de clusters para os marcadores
    const markersCluster = L.markerClusterGroup({
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: false
    });
    map.addLayer(markersCluster);

    // Evento para exibir popup com lista de participantes de um cluster
    markersCluster.on('clusterclick', function (a) {
      const markers = a.layer.getAllChildMarkers();
      let content = '<ul style="list-style:none; margin:0; padding:0;">';
      markers.forEach(marker => {
        const p = marker.options.participant;
        content += `<li style="padding:4px 0;">${p.name} - ${p.phone}</li>`;
      });
      content += '</ul>';
      L.popup()
        .setLatLng(a.latlng)
        .setContent(content)
        .openOn(map);
    });

    // Função para carregar os participantes do Firestore e adicionar os marcadores
    async function loadParticipants() {
      // Limpa os marcadores do cluster
      markersCluster.clearLayers();

      const querySnapshot = await getDocs(collection(db, "participants"));
      querySnapshot.forEach((doc) => {
        const participant = doc.data();

        // Somente adiciona se houver coordenadas para a cidade selecionada
        if (cityCoordinates[participant.city]) {
          let color;
          if (participant.status === "participou") {
            color = "green";
          } else if (participant.status === "nao_participou") {
            color = "red";
          } else { // "participou_outros"
            color = "yellow";
          }

          const marker = L.circleMarker(cityCoordinates[participant.city], {
            color: color,
            radius: 8,
            fillOpacity: 0.8
          });
          // Armazena informações do participante no marcador para uso no popup
          marker.options.participant = participant;
          marker.bindPopup(`<strong>${participant.name}</strong><br>Telefone: ${participant.phone}`);

          // Adiciona o marcador ao grupo de clusters
          markersCluster.addLayer(marker);
        }
      });
    }

    // Ao enviar o formulário, adiciona o participante ao Firestore e atualiza o mapa
    document.getElementById("participantForm").addEventListener("submit", async function (event) {
      event.preventDefault();
      const name = document.getElementById("name").value;
      const phone = document.getElementById("phone").value;
      const city = document.getElementById("city").value;
      const status = document.getElementById("status").value;

      if (!city) {
        alert("Por favor, selecione uma cidade.");
        return;
      }

      try {
        await addDoc(collection(db, "participants"), { name, phone, city, status });
        alert("Participante adicionado!");
        loadParticipants();  // Atualiza os marcadores no mapa
      } catch (error) {
        console.error("Erro ao adicionar participante:", error);
      }
    });

    // Carrega os participantes e os marcadores ao iniciar a página
    document.addEventListener("DOMContentLoaded", loadParticipants);
  </script>
  <!-- Leaflet MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
</body>
</html>
