<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Participantes</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places,visualization"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markerclustererplus/2.1.1/markerclustererplus.min.js"></script>
</head>
<body>
    <h1>Relatório de Participantes</h1>
    
    <form id="participantForm">
        <input type="text" id="name" placeholder="Nome" required>
        <input type="text" id="phone" placeholder="Telefone" required>
        <input type="text" id="city" placeholder="Cidade" required>
        <select id="status">
            <option value="participou">Participou</option>
            <option value="nao_participou">Não Participou</option>
            <option value="participou_outros">Participou com Outros</option>
        </select>
        <button type="submit">Adicionar</button>
    </form>

    <h2>Lista de Participantes</h2>
    <ul id="participantsList"></ul>

    <div id="map" style="height: 500px; width: 100%;"></div>

    <!-- Importando Firebase e Configuração -->
    <script type="module" src="./js/firebase-config.js"></script>
    <script type="module">
        import { db } from "./js/firebase-config.js";
        import { collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

        const cityCoordinates = {
            "São Paulo": { lat: -23.5505, lng: -46.6333 },
            // Adicione mais cidades e suas coordenadas aqui
        };

        let map;
        let markerCluster;

        // Inicializa o mapa
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -23.5505, lng: -46.6333 }, // Posição central (São Paulo)
                zoom: 12
            });

            markerCluster = new MarkerClusterer(map, [], {
                imagePath: "https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m"
            });

            loadParticipants(); // Carrega os participantes ao iniciar
        }

        // Formulário para adicionar participante
        document.getElementById("participantForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            const name = document.getElementById("name").value;
            const phone = document.getElementById("phone").value;
            const city = document.getElementById("city").value;
            const status = document.getElementById("status").value;

            try {
                await addDoc(collection(db, "participants"), { name, phone, city, status });
                alert("Participante adicionado!");
                loadParticipants(); // Atualiza lista sem precisar recarregar a página
            } catch (error) {
                console.error("Erro ao adicionar participante:", error);
            }
        });

        // Função para carregar os participantes e adicionar marcadores
        async function loadParticipants() {
            const querySnapshot = await getDocs(collection(db, "participants"));
            querySnapshot.forEach((doc) => {
                const participant = doc.data();
                const city = participant.city;
                const status = participant.status;

                // Se a cidade for conhecida, adiciona no mapa
                if (cityCoordinates[city]) {
                    const position = cityCoordinates[city];
                    const color = status === "participou" ? "green" : (status === "nao_participou" ? "red" : "yellow");

                    const marker = new google.maps.Marker({
                        position,
                        map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: color,
                            fillOpacity: 0.8,
                            strokeWeight: 0,
                            scale: 8
                        }
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `<h3>${participant.name}</h3><p>Telefone: ${participant.phone}</p>`
                    });

                    // Quando o marcador é clicado, exibe o popup com as informações
                    marker.addListener("click", () => {
                        infoWindow.open(map, marker);
                    });

                    // Adiciona o marcador ao cluster
                    markerCluster.addMarker(marker);
                }
            });
        }

        // Carrega o mapa ao iniciar a página
        document.addEventListener("DOMContentLoaded", initMap);
    </script>
</body>
</html>
